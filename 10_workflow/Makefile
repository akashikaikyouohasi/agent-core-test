.PHONY: help setup install activate clean run-simple run-workflow test deploy logs

# ä»®æƒ³ç’°å¢ƒã®ãƒ‘ã‚¹
VENV := .venv
PYTHON := $(VENV)/bin/python
PIP := $(VENV)/bin/pip
UV := uv

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
ENTRYPOINT := agents.py
# AWS
REGION := us-west-2

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make setup          - uv ã§ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆ"
	@echo "  make install        - å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make activate       - ä»®æƒ³ç’°å¢ƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆæ–¹æ³•ã‚’è¡¨ç¤º"
	@echo "  make clean          - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"
	@echo "  make run-simple     - ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ"
	@echo "  make run-workflow   - è¤‡é›‘ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ"
	@echo "  make test           - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  make deploy         - AgentCoreã«ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make logs           - ãƒ­ã‚°ã‚’è¡¨ç¤º"

# uv ã§ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆ
setup:
	@echo "uv venv [NAME]ã§ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆä¸­..."
	$(UV) venv $(VENV)
	@echo "âœ… ä»®æƒ³ç’°å¢ƒãŒä½œæˆã•ã‚Œã¾ã—ãŸ: $(VENV)"
	@echo ""
	@echo "æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã—ã¦ãã ã•ã„:"
	@echo "  source $(VENV)/bin/activate"
	@echo ""
	@echo "ãã®å¾Œã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:"
	@echo "  make install"

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆä»®æƒ³ç’°å¢ƒãŒå¿…è¦ï¼‰
install:
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ ä»®æƒ³ç’°å¢ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãš 'make setup' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi
	@echo "uv pip install [ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å] ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	$(UV) pip install -r requirements.txt
	@echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

# ä»®æƒ³ç’°å¢ƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆæ–¹æ³•ã‚’è¡¨ç¤º
activate:
	@echo "ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã™ã‚‹ã«ã¯:"
	@echo "  source $(VENV)/bin/activate"
	@echo ""
	@echo "éã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã™ã‚‹ã«ã¯:"
	@echo "  deactivate"

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
clean:
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.log" -delete
	rm -rf .pytest_cache
	rm -rf htmlcov
	rm -rf .coverage

# ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
run-simple:
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ ä»®æƒ³ç’°å¢ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make setup' ã¨ 'make install' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi
	$(PYTHON) simple_workflow.py

# è¤‡é›‘ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
run-workflow:
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ ä»®æƒ³ç’°å¢ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make setup' ã¨ 'make install' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi
	$(PYTHON) workflow_example.py

# ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
test:
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ ä»®æƒ³ç’°å¢ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make setup' ã¨ 'make install' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi
	$(PYTHON) -m pytest tests/ -v

# ãƒ­ã‚°ã‚’è¡¨ç¤º
logs:
	tail -f *.log 2>/dev/null || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

check-venv:
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ ä»®æƒ³ç’°å¢ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make setup' ã¨ 'make install' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi

# AgentCoreã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
agentcore-setup: check-venv
	@echo "AgentCoreã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹..."
	agentcore configure --entrypoint $(ENTRYPOINT) --region $(REGION) --name test_agent

# ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
agentcore-local: check-venv
	@echo "AgentCoreã®ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã‚’é–‹å§‹..."
	@echo "âš ï¸  Ctrl+C ã§åœæ­¢ã§ãã¾ã™"
	@echo "âš ï¸  åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make agentcore-local-test' ã‚’å®Ÿè¡Œã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„"
	agentcore launch --local --env OTEL_SDK_DISABLED=true 

agentcore-local-test: check-venv
	@echo "ğŸ“¡ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼(localhost:8080)ã®æ¥ç¶šã‚’ç¢ºèªä¸­..."
	@if curl -s http://localhost:8080/health > /dev/null 2>&1 || nc -z localhost 8080 > /dev/null 2>&1; then \
		echo "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã™"; \
	else \
		echo "âŒ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"; \
		echo ""; \
		echo "åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„:"; \
		echo "  make agentcore-local"; \
		exit 1; \
	fi
	@echo "AgentCoreã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹..."
	agentcore invoke --local '{"prompt": "ï¼‘ãŸã™ï¼‘ã¯ï¼Ÿ"}'
	agentcore invoke --local '{"prompt": "ç§ãŒä»Šã„ã‚‹å ´æ‰€ã®å¤©æ°—ã¯ï¼Ÿ"}'
agentcore-local-test-workflow: check-venv
	@echo "ğŸ“¡ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼(localhost:8080)ã®æ¥ç¶šã‚’ç¢ºèªä¸­..."
	@if curl -s http://localhost:8080/health > /dev/null 2>&1 || nc -z localhost 8080 > /dev/null 2>&1; then \
		echo "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã™"; \
	else \
		echo "âŒ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"; \
		echo ""; \
		echo "åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„:"; \
		echo "  make agentcore-local"; \
		exit 1; \
	fi
	@echo "AgentCoreã®workflowã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹..."
	agentcore invoke --local '{"prompt": "å››åŠæœŸã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"}'
agentcore-deploy: check-venv
	@echo "AgentCoreã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹..."
	agentcore launch

agentcore-status: check-venv
	@echo "AgentCoreã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º..."
	agentcore status
agentcore-invoke-test: check-venv
	@echo "AgentCoreã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡..."
	agentcore invoke '{"prompt": "ï¼‘ãŸã™ï¼‘ã¯ï¼Ÿ"}'
	agentcore invoke '{"prompt": "ç§ãŒä»Šã„ã‚‹å ´æ‰€ã®å¤©æ°—ã¯ï¼Ÿ"}'
agentcore-invoke-test-workflow: check-venv
	@echo "AgentCoreã¸ã®workflowãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡..."
	agentcore invoke '{"prompt": "å››åŠæœŸã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"}'
